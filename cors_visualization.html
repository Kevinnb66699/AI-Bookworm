<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 CORS错误可视化演示</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            line-height: 1.6;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        .step {
            background: #f8f9fa;
            border-left: 5px solid #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            position: relative;
        }
        .step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .step.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .arrow {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
            color: #007bff;
        }
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #ffeaa7;
            padding: 2px 5px;
            border-radius: 3px;
            color: #2d3436;
            font-weight: bold;
        }
        .demo-section {
            margin: 30px 0;
        }
        .url-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .url-box {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .same-origin {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .cross-origin {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        .flow-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .flow-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            min-width: 150px;
        }
        .browser {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .server {
            background: #f3e5f5;
            border: 2px solid #9c27b0;
        }
        .blocked {
            background: #ffebee;
            border: 2px solid #f44336;
        }
        .allowed {
            background: #e8f5e8;
            border: 2px solid #4caf50;
        }
        .interactive-demo {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .error-btn {
            background: #dc3545;
        }
        .success-btn {
            background: #28a745;
        }
        #demoResult {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 CORS错误可视化演示</h1>
        <p>通过可视化的方式理解CORS错误的完整过程</p>
    </div>

    <div class="container">
        <h2>📚 什么是同源和跨域？</h2>
        
        <div class="url-comparison">
            <div class="url-box same-origin">
                <h3>✅ 同源（允许）</h3>
                <div class="code">
                    当前页面: https://example.com<br>
                    请求目标: https://example.com/api
                </div>
                <p>协议、域名、端口都相同</p>
            </div>
            
            <div class="url-box cross-origin">
                <h3>❌ 跨域（需要CORS）</h3>
                <div class="code">
                    当前页面: https://frontend.vercel.app<br>
                    请求目标: https://backend.vercel.app/api
                </div>
                <p>域名不同，需要CORS配置</p>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🔄 CORS错误的完整过程</h2>
        
        <div class="step">
            <h3>第1步：前端发起请求</h3>
            <div class="code">
fetch('https://ai-bookworm-backend.vercel.app/health')
  .then(response => response.json())
  .then(data => console.log(data));
            </div>
        </div>

        <div class="arrow">⬇️</div>

        <div class="step">
            <h3>第2步：浏览器检查跨域</h3>
            <p>浏览器发现：</p>
            <ul>
                <li>当前页面：<span class="highlight">ai-bookworm-frontend2.vercel.app</span></li>
                <li>目标API：<span class="highlight">ai-bookworm-backend.vercel.app</span></li>
                <li>结论：<span class="highlight">跨域！需要CORS检查</span></li>
            </ul>
        </div>

        <div class="arrow">⬇️</div>

        <div class="step">
            <h3>第3步：发送预检请求（OPTIONS）</h3>
            <div class="code">
OPTIONS /health HTTP/1.1
Host: ai-bookworm-backend.vercel.app
Origin: https://ai-bookworm-frontend2.vercel.app
Access-Control-Request-Method: GET
            </div>
            <p>浏览器自动发送询问："我可以从frontend2访问backend吗？"</p>
        </div>

        <div class="arrow">⬇️</div>

        <div class="step success">
            <h3>第4a步：服务器正确响应（✅ 成功情况）</h3>
            <div class="code">
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://ai-bookworm-frontend2.vercel.app
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
            </div>
            <p>服务器说："✅ 允许！你可以访问我的API"</p>
        </div>

        <div class="step error">
            <h3>第4b步：服务器错误响应（❌ 失败情况）</h3>
            <div class="code">
HTTP/1.1 200 OK
Content-Type: application/json
(没有CORS头部)
            </div>
            <p>服务器说："❌ 我不知道什么是CORS，我不允许跨域"</p>
        </div>

        <div class="arrow">⬇️</div>

        <div class="step success">
            <h3>第5a步：浏览器允许请求（✅ 成功情况）</h3>
            <p>浏览器："好的，服务器允许了，我可以发送实际的API请求"</p>
            <div class="code">
GET /health HTTP/1.1
Host: ai-bookworm-backend.vercel.app
Origin: https://ai-bookworm-frontend2.vercel.app
            </div>
        </div>

        <div class="step error">
            <h3>第5b步：浏览器阻止请求（❌ 失败情况）</h3>
            <p>浏览器："服务器没有明确允许，为了安全，我拒绝这个请求"</p>
            <div class="code">
Console Error:
Access to fetch at 'https://ai-bookworm-backend.vercel.app/health' 
from origin 'https://ai-bookworm-frontend2.vercel.app' 
has been blocked by CORS policy
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🔄 请求流程可视化</h2>
        
        <div class="flow-container">
            <div class="flow-item browser">
                <strong>🌐 浏览器</strong><br>
                检查跨域
            </div>
            <div style="font-size: 24px;">➡️</div>
            <div class="flow-item server">
                <strong>🔍 预检请求</strong><br>
                OPTIONS /health
            </div>
            <div style="font-size: 24px;">➡️</div>
            <div class="flow-item server">
                <strong>🖥️ 后端服务器</strong><br>
                检查CORS配置
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 24px;">⬇️</div>
        </div>

        <div class="flow-container">
            <div class="flow-item allowed">
                <strong>✅ 配置正确</strong><br>
                返回CORS头部<br>
                允许实际请求
            </div>
            <div style="font-size: 24px;">VS</div>
            <div class="flow-item blocked">
                <strong>❌ 配置错误</strong><br>
                无CORS头部<br>
                浏览器阻止请求
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🎮 交互式演示</h2>
        
        <div class="interactive-demo">
            <h3>模拟不同的CORS场景</h3>
            <p>点击按钮体验不同的CORS配置结果：</p>
            
            <button onclick="simulateSuccess()" class="success-btn">✅ 模拟CORS成功</button>
            <button onclick="simulateError()" class="error-btn">❌ 模拟CORS错误</button>
            <button onclick="simulateProxy()">🔄 模拟代理解决</button>
            
            <div id="demoResult"></div>
        </div>
    </div>

    <div class="container">
        <h2>💡 关键理解点</h2>
        
        <div class="step">
            <h3>🛡️ CORS是浏览器的安全机制</h3>
            <p>不是服务器错误，而是浏览器保护用户的安全功能</p>
        </div>

        <div class="step">
            <h3>🔍 错误发生在客户端</h3>
            <p>请求实际上到达了服务器，服务器也正常响应了，但浏览器阻止了JavaScript访问响应</p>
        </div>

        <div class="step">
            <h3>🔧 需要服务器明确允许</h3>
            <p>服务器必须通过响应头明确说："我允许这个域名访问我的资源"</p>
        </div>

        <div class="step">
            <h3>🚫 直接访问URL不会有CORS错误</h3>
            <p>在地址栏直接访问API URL是可以的，CORS只影响JavaScript的跨域请求</p>
        </div>
    </div>

    <script>
        function simulateSuccess() {
            const result = document.getElementById('demoResult');
            result.className = 'step success';
            result.innerHTML = `
                <h4>✅ CORS成功流程</h4>
                <div class="code">
1. 浏览器发送预检请求：OPTIONS /health
2. 服务器响应：Access-Control-Allow-Origin: https://frontend.vercel.app
3. 浏览器："好的，允许访问"
4. 发送实际请求：GET /health
5. 获取数据：{"status": "healthy"}
                </div>
                <p><strong>结果：</strong> 🎉 请求成功，数据正常显示</p>
            `;
        }

        function simulateError() {
            const result = document.getElementById('demoResult');
            result.className = 'step error';
            result.innerHTML = `
                <h4>❌ CORS错误流程</h4>
                <div class="code">
1. 浏览器发送预检请求：OPTIONS /health
2. 服务器响应：200 OK (但没有CORS头部)
3. 浏览器："服务器没有明确允许，拒绝访问"
4. 显示错误：CORS policy blocked
5. JavaScript无法获取数据
                </div>
                <p><strong>结果：</strong> 🚨 请求被阻止，控制台显示CORS错误</p>
            `;
        }

        function simulateProxy() {
            const result = document.getElementById('demoResult');
            result.className = 'step';
            result.innerHTML = `
                <h4>🔄 代理解决方案</h4>
                <div class="code">
1. 前端请求：cors-anywhere.herokuapp.com/backend.vercel.app/health
2. 代理服务器：接收请求，转发给真正的后端
3. 后端：正常响应数据给代理服务器
4. 代理服务器：添加CORS头部，返回给前端
5. 浏览器："代理服务器允许了，OK"
                </div>
                <p><strong>结果：</strong> 🎯 绕过CORS限制，成功获取数据</p>
                <p><strong>注意：</strong> 这是临时解决方案，最好还是修复后端CORS配置</p>
            `;
        }

        // 页面加载时显示初始说明
        window.onload = function() {
            const result = document.getElementById('demoResult');
            result.innerHTML = `
                <p>👆 点击上面的按钮查看不同CORS场景的模拟演示</p>
            `;
        };
    </script>
</body>
</html> 