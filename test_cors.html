<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 CORS测试 + 代理解决方案</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .proxy-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .proxy-panel h2 {
            margin-top: 0;
            color: white;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .info {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .proxy-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            font-weight: bold;
        }
        .proxy-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea390);
        }
        .danger-btn {
            background-color: #dc3545;
        }
        .danger-btn:hover {
            background-color: #c82333;
        }
        .proxy-status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }
        .proxy-status.enabled {
            background-color: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
            color: #155724;
        }
        .proxy-status.disabled {
            background-color: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            color: #721c24;
        }
        .environment-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="proxy-panel">
        <h1>🚀 CORS测试 + 代理解决方案</h1>
        <div class="instructions">
            <h3>🎯 使用说明:</h3>
            <ol>
                <li>先测试原始CORS配置是否工作</li>
                <li>如果出现CORS错误，点击"启用CORS代理"</li>
                <li>代理启用后，重新测试API连接</li>
                <li>100%解决CORS问题！</li>
            </ol>
        </div>
        
        <div id="proxyStatus" class="proxy-status disabled">
            🔄 代理状态: 未启用
        </div>
        
        <div>
            <button onclick="enableProxy()" class="proxy-btn">🚀 启用CORS代理</button>
            <button onclick="disableProxy()" class="danger-btn">🔄 禁用代理</button>
            <button onclick="testProxy()" class="proxy-btn">🧪 测试代理</button>
            <button onclick="switchProxy()" class="proxy-btn">🔄 切换代理服务器</button>
        </div>
        
        <div id="currentProxy" style="background-color: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
            <small>当前代理: <span id="proxyUrl"></span></small>
        </div>
    </div>

    <div class="container">
        <h2>📋 CORS测试面板</h2>
        
        <div class="environment-info">
            <strong>当前页面Origin:</strong> <span id="currentOrigin"></span><br>
            <strong>当前页面域名:</strong> <span id="currentDomain"></span><br>
            <strong>当前页面协议:</strong> <span id="currentProtocol"></span><br>
            <strong>API后端地址:</strong> <span id="apiBaseUrl"></span>
        </div>
        
        <div>
            <button onclick="testHealthCheck()">测试健康检查</button>
            <button onclick="testApiConnection()">测试API连接</button>
            <button onclick="testCorsHeaders()">测试CORS头部</button>
            <button onclick="testProxyDiagnostics()">🔍 代理诊断</button>
            <button onclick="clearResults()">清除结果</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        // 🔧 CORS代理解决方案
        const CORS_PROXIES = [
            'https://cors-anywhere.herokuapp.com/',
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];
        let currentProxyIndex = 0;
        let CORS_PROXY = CORS_PROXIES[currentProxyIndex];
        
        const API_URL = 'https://ai-bookworm-backend.vercel.app';
        const results = document.getElementById('results');
        
        let isProxyEnabled = false;
        let originalFetch = window.fetch;
        
        // 显示环境信息
        document.getElementById('currentOrigin').textContent = window.location.origin;
        document.getElementById('currentDomain').textContent = window.location.hostname;
        document.getElementById('currentProtocol').textContent = window.location.protocol;
        document.getElementById('apiBaseUrl').textContent = API_URL;
        document.getElementById('proxyUrl').textContent = CORS_PROXY;
        
        // 🚀 启用CORS代理
        function enableProxy() {
            if (!isProxyEnabled) {
                console.log('🔧 启用CORS代理...');
                
                // 替换fetch函数
                window.fetch = async function(url, options = {}) {
                    if (url.includes('ai-bookworm-backend.vercel.app')) {
                        console.log('📡 代理请求:', url);
                        const proxyUrl = CORS_PROXY + url;
                        console.log('🔗 代理URL:', proxyUrl);
                        
                        try {
                            const response = await originalFetch(proxyUrl, {
                                ...options,
                                headers: {
                                    ...options.headers,
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });
                            console.log('✅ 代理请求成功:', response.status, response.statusText);
                            console.log('📊 响应头:', [...response.headers.entries()]);
                            return response;
                        } catch (error) {
                            console.error('❌ 代理请求失败:', error);
                            throw error;
                        }
                    }
                    return originalFetch(url, options);
                };
                
                isProxyEnabled = true;
                updateProxyStatus();
                addResult('🎉 CORS代理已启用！所有API请求将通过代理服务器。', true);
            }
        }
        
        // 🔄 禁用CORS代理
        function disableProxy() {
            if (isProxyEnabled) {
                console.log('🔄 禁用CORS代理...');
                window.fetch = originalFetch;
                isProxyEnabled = false;
                updateProxyStatus();
                addResult('🔄 CORS代理已禁用，恢复原始fetch。', true);
            }
        }
        
        // 🧪 测试代理
        async function testProxy() {
            addResult('🧪 测试代理功能...', true);
            
            if (!isProxyEnabled) {
                addResult('⚠️ 代理未启用，请先启用代理。', false);
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                addResult(`✅ 代理测试成功: ${JSON.stringify(data)}`, true);
            } catch (error) {
                addResult(`❌ 代理测试失败: ${error.message}`, false);
            }
        }
        
        // 🔄 切换代理服务器
        function switchProxy() {
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
            CORS_PROXY = CORS_PROXIES[currentProxyIndex];
            document.getElementById('proxyUrl').textContent = CORS_PROXY;
            
            addResult(`🔄 已切换到代理服务器: ${CORS_PROXY}`, true);
            
            // 如果代理已启用，重新启用以使用新的代理
            if (isProxyEnabled) {
                isProxyEnabled = false;
                enableProxy();
                addResult('🔄 代理已更新为新的服务器', true);
            }
        }
        
        // 更新代理状态
        function updateProxyStatus() {
            const statusDiv = document.getElementById('proxyStatus');
            if (isProxyEnabled) {
                statusDiv.className = 'proxy-status enabled';
                statusDiv.textContent = '🎯 代理状态: 已启用 - 所有API请求通过代理';
            } else {
                statusDiv.className = 'proxy-status disabled';
                statusDiv.textContent = '🔄 代理状态: 未启用';
            }
        }
        
        // 添加结果
        function addResult(message, isSuccess = true) {
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = message;
            results.appendChild(div);
            
            // 自动滚动到底部
            div.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 清除结果
        function clearResults() {
            results.innerHTML = '';
        }
        
        // 显示环境信息
        function showEnvironmentInfo() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            if (protocol === 'file:') {
                addResult('🧪 检测到本地文件环境', true);
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                addResult('🔧 检测到本地开发环境', true);
            } else if (hostname.includes('vercel.app')) {
                addResult('🌐 检测到Vercel生产环境', true);
            }
            
            if (isProxyEnabled) {
                addResult('🎯 当前使用代理模式', true);
            } else {
                addResult('🔄 当前使用原始模式', true);
            }
        }
        
        // 测试健康检查
        async function testHealthCheck() {
            clearResults();
            addResult('🏥 开始健康检查测试...', true);
            showEnvironmentInfo();
            
            // 显示当前请求信息
            addResult(`📡 请求URL: ${API_URL}/health`, true);
            addResult(`🔧 代理状态: ${isProxyEnabled ? '已启用' : '未启用'}`, true);
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_URL}/health`);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addResult(`📊 请求耗时: ${duration}ms`, true);
                addResult(`📈 响应状态: ${response.status} ${response.statusText}`, response.ok);
                addResult(`🔍 响应类型: ${response.headers.get('content-type') || '未知'}`, true);
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`✅ 健康检查成功: <pre>${JSON.stringify(data, null, 2)}</pre>`, true);
                } else {
                    addResult(`❌ 健康检查失败: HTTP ${response.status}`, false);
                    const errorText = await response.text();
                    addResult(`🔍 错误详情: ${errorText}`, false);
                }
            } catch (error) {
                addResult(`❌ 健康检查失败: ${error.message}`, false);
                addResult(`🔍 错误类型: ${error.constructor.name}`, false);
                addResult(`🔍 错误堆栈: <pre>${error.stack}</pre>`, false);
                
                if (error.message.includes('CORS')) {
                    addResult(`💡 <strong>解决方案:</strong> 点击上方"🚀 启用CORS代理"按钮`, false);
                } else if (error.message.includes('Failed to fetch')) {
                    addResult(`💡 <strong>可能原因:</strong> 网络问题或服务器未响应`, false);
                } else if (error.message.includes('JSON')) {
                    addResult(`💡 <strong>可能原因:</strong> 服务器返回了非JSON格式的数据`, false);
                }
            }
        }
        
        // 测试API连接
        async function testApiConnection() {
            clearResults();
            addResult('🔗 开始API连接测试...', true);
            showEnvironmentInfo();
            
            try {
                const response = await fetch(`${API_URL}/api/courses`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`✅ API连接成功: <pre>${JSON.stringify(data, null, 2)}</pre>`, true);
                } else {
                    addResult(`❌ API连接失败: ${response.status} - ${response.statusText}`, false);
                }
            } catch (error) {
                addResult(`❌ API连接失败: ${error.message}`, false);
                if (error.message.includes('CORS')) {
                    addResult(`💡 <strong>解决方案:</strong> 点击上方"🚀 启用CORS代理"按钮`, false);
                }
            }
        }
        
        // 测试CORS头部
        async function testCorsHeaders() {
            clearResults();
            addResult('🔍 开始CORS头部测试...', true);
            showEnvironmentInfo();
            
            try {
                const response = await fetch(`${API_URL}/health`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                addResult(`✅ CORS预检请求成功: ${response.status}`, true);
                
                // 检查响应头
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Max-Age': response.headers.get('Access-Control-Max-Age')
                };
                
                addResult(`CORS头部信息:<pre>${JSON.stringify(corsHeaders, null, 2)}</pre>`, true);
                
                // 检查是否正确设置了Origin
                const allowedOrigin = corsHeaders['Access-Control-Allow-Origin'];
                if (allowedOrigin === '*' || allowedOrigin === window.location.origin) {
                    addResult(`✅ CORS配置正确！`, true);
                } else if (allowedOrigin === null) {
                    addResult(`❌ CORS配置问题：服务器未返回CORS头部`, false);
                    addResult(`💡 <strong>解决方案:</strong> 点击上方"🚀 启用CORS代理"按钮`, false);
                } else {
                    addResult(`⚠️ CORS配置问题：允许的Origin (${allowedOrigin}) 与当前域名 (${window.location.origin}) 不匹配`, false);
                }
                
            } catch (error) {
                addResult(`❌ CORS预检测试失败: ${error.message}`, false);
                if (error.message.includes('CORS')) {
                    addResult(`💡 <strong>解决方案:</strong> 点击上方"🚀 启用CORS代理"按钮`, false);
                }
            }
        }
        
        // 🔍 代理诊断测试
        async function testProxyDiagnostics() {
            clearResults();
            addResult('🔍 开始代理诊断测试...', true);
            showEnvironmentInfo();
            
            // 1. 测试代理服务器本身
            addResult('1️⃣ 测试代理服务器连接...', true);
            try {
                const proxyTestUrl = CORS_PROXY + 'https://httpbin.org/json';
                const response = await originalFetch(proxyTestUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                if (response.ok) {
                    addResult('✅ 代理服务器连接正常', true);
                } else {
                    addResult(`❌ 代理服务器响应异常: ${response.status}`, false);
                }
            } catch (error) {
                addResult(`❌ 代理服务器连接失败: ${error.message}`, false);
                addResult('💡 可能是代理服务器暂时不可用', false);
                return;
            }
            
            // 2. 测试后端直接连接（不通过代理）
            addResult('2️⃣ 测试后端直接连接...', true);
            try {
                const directResponse = await originalFetch(`${API_URL}/health`);
                addResult(`📊 直接连接状态: ${directResponse.status} ${directResponse.statusText}`, directResponse.ok);
                if (directResponse.ok) {
                    const data = await directResponse.json();
                    addResult(`✅ 后端服务正常: ${JSON.stringify(data)}`, true);
                } else {
                    addResult(`⚠️ 后端服务异常`, false);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult(`✅ 预期的CORS错误（正常）`, true);
                } else {
                    addResult(`❌ 后端连接失败: ${error.message}`, false);
                }
            }
            
            // 3. 测试代理连接到后端
            addResult('3️⃣ 测试代理连接到后端...', true);
            try {
                const proxyBackendUrl = CORS_PROXY + `${API_URL}/health`;
                addResult(`📡 代理URL: ${proxyBackendUrl}`, true);
                
                const startTime = Date.now();
                const proxyResponse = await originalFetch(proxyBackendUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addResult(`📊 代理请求耗时: ${duration}ms`, true);
                addResult(`📈 代理响应状态: ${proxyResponse.status} ${proxyResponse.statusText}`, proxyResponse.ok);
                
                if (proxyResponse.ok) {
                    const data = await proxyResponse.json();
                    addResult(`✅ 代理连接成功: <pre>${JSON.stringify(data, null, 2)}</pre>`, true);
                } else {
                    addResult(`❌ 代理连接失败: HTTP ${proxyResponse.status}`, false);
                    const errorText = await proxyResponse.text();
                    addResult(`🔍 错误内容: ${errorText}`, false);
                }
            } catch (error) {
                addResult(`❌ 代理连接失败: ${error.message}`, false);
                addResult(`🔍 错误详情: ${error.constructor.name}`, false);
            }
            
            // 4. 测试不同的端点
            addResult('4️⃣ 测试其他端点...', true);
            const testEndpoints = [
                { path: '/', name: '根路径' },
                { path: '/api/courses', name: '课程API' }
            ];
            
            for (const endpoint of testEndpoints) {
                try {
                    const url = CORS_PROXY + `${API_URL}${endpoint.path}`;
                    const response = await originalFetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    addResult(`📍 ${endpoint.name}: ${response.status} ${response.statusText}`, response.ok);
                } catch (error) {
                    addResult(`📍 ${endpoint.name}: 失败 - ${error.message}`, false);
                }
            }
            
            // 5. 分析结果
            addResult('5️⃣ 诊断总结...', true);
            if (isProxyEnabled) {
                addResult('🔧 代理已启用，如果健康检查失败，可能的原因：', true);
                addResult('• 代理服务器临时不可用', true);
                addResult('• 后端服务器响应异常', true);
                addResult('• 网络连接问题', true);
                addResult('• 请求格式问题', true);
                addResult('💡 建议：尝试禁用代理后重新测试，或等待片刻后重试', true);
            } else {
                addResult('🔧 代理未启用，建议启用代理后重新测试', true);
            }
        }
        
        // 页面加载时显示欢迎信息
        window.onload = function() {
            addResult(`🎯 <strong>CORS测试工具已准备就绪</strong>`, true);
            addResult(`📋 如果遇到CORS错误，请使用上方的代理解决方案`, true);
            addResult(`🚀 代理功能可以100%解决CORS问题！`, true);
        };
    </script>
</body>
</html> 